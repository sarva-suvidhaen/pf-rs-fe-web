<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Passenger Feedback</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Popup Modal Styles */
    .popup-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background: #fff;
      padding: 24px 32px;
      border-radius: 8px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .popup-content p {
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 500;
    }

    .popup-content .btn {
      width: 100px;
    }
  </style>
</head>
<body>
  <div class="app-bar">
    <h1>Passenger Feedback</h1>
  </div>

  <div class="page">
    <form id="feedbackForm" class="form">
      <!-- Station Code / Name -->
      <div class="field">
        <label for="station">Station Code / Name</label>
        <input id="station" type="text" value="Detecting station..." readonly />
      </div>

      <!-- Date -->
      <div class="field">
        <label for="date">Date</label>
        <input id="date" type="date" required />
      </div>

      <!-- Passenger name -->
      <div class="field">
        <label for="name">Passenger Name *</label>
        <input id="name" type="text" placeholder="Passenger Name" required />
      </div>

      <!-- Ticket / employee -->
      <div class="field">
        <label for="ticket">Ticket/Employee Number *</label>
        <small>Enter ticket/employee number (max 20 characters)</small>
        <input id="ticket" type="text" maxlength="20" placeholder="Ticket/Employee Number" required />
      </div>

      <!-- Mobile -->
      <div class="field">
        <label for="mobile">Mobile Number *</label>
        <input id="mobile" type="tel" required pattern="[0-9]{10}" maxlength="10" placeholder="10 digit mobile number" />
      </div>

      <!-- Email -->
      <div class="field">
        <label for="email">Email ID</label>
        <div class="row">
          <input id="email" type="email" class="flex-1" required placeholder="example@gmail.com" />
        </div>
      </div>

      <!-- Detailed table rating (DNR only) -->
      <div class="dnr-rating" id="dnrRatingSection">
        <p class="section-title">Please tick (✓) in appropriate column</p>
        <div class="table-wrapper">
          <table class="feedback-table" id="feedbackTable">
            <thead>
              <tr>
                <th>ITEM</th>
                <th class="rotated">Excellent</th>
                <th class="rotated">OK</th>
                <th class="rotated">Poor</th>
              </tr>
            </thead>
            <tbody>
              <tr data-row="0">
                <td>General Cleaning of platform</td>
                <td class="rate-cell" data-value="2"></td>
                <td class="rate-cell" data-value="1"></td>
                <td class="rate-cell" data-value="0"></td>
              </tr>
              <tr data-row="1">
                <td>General Cleaning of rail line (track) of Platform</td>
                <td class="rate-cell" data-value="2"></td>
                <td class="rate-cell" data-value="1"></td>
                <td class="rate-cell" data-value="0"></td>
              </tr>
              <tr data-row="2">
                <td>Cleaning of toilets/ Urinals/ Water booth etc.</td>
                <td class="rate-cell" data-value="2"></td>
                <td class="rate-cell" data-value="1"></td>
                <td class="rate-cell" data-value="0"></td>
              </tr>
              <tr data-row="3">
                <td>Cleaning of dustbin and disposal of garbage</td>
                <td class="rate-cell" data-value="2"></td>
                <td class="rate-cell" data-value="1"></td>
                <td class="rate-cell" data-value="0"></td>
              </tr>
              <tr data-row="4">
                <td>General Cleaning of waiting hall</td>
                <td class="rate-cell" data-value="2"></td>
                <td class="rate-cell" data-value="1"></td>
                <td class="rate-cell" data-value="0"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Simple overall rating (non‑DNR) -->
      <div class="field" id="simpleRatingSection">
        <p class="section-title">Overall Rating</p>
        <div class="overall-rating" id="overallRating">
          <button type="button" class="rating-chip excellent" data-value="2">Excellent</button>
          <button type="button" class="rating-chip ok" data-value="1">OK</button>
          <button type="button" class="rating-chip poor" data-value="0">Poor</button>
        </div>
      </div>

      <!-- Submit button (hidden until station ready) -->
      <button type="submit" class="btn primary full-width" id="submitBtn" style="display:none" disabled>Submit Feedback</button>
    </form>
  </div>

  <!-- Popup Modal -->
  <div id="feedbackPopup" class="popup-modal">
    <div class="popup-content">
      <p id="popupMessage">Thank you for submitting your feedback!</p>
      <button id="popupCloseBtn" class="btn primary">OK</button>
    </div>
  </div>

  <script>
    let curatedStations = [];
    const rowRatings = {};
    let overallRating = null;
    let resetFormOnClose = false; // New flag to handle form reset on popup close

    function setTodayDate() {
      const dateInput = document.getElementById("date");
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    function setSubmitEnabled(enabled) {
      const btn = document.getElementById("submitBtn");
      btn.style.display = enabled ? "block" : "none";
      btn.disabled = !enabled;
    }

    function showPopup(message, resetForm = false) {
      const popup = document.getElementById("feedbackPopup");
      const msg = document.getElementById("popupMessage");
      msg.textContent = message;
      popup.style.display = "flex";
      resetFormOnClose = resetForm;
    }

    document.getElementById("popupCloseBtn").addEventListener("click", () => {
      const popup = document.getElementById("feedbackPopup");
      popup.style.display = "none";

      if (resetFormOnClose) {
        const form = document.getElementById("feedbackForm");
        form.reset();

        overallRating = null;
        Object.keys(rowRatings).forEach(k => delete rowRatings[k]);

        document.querySelectorAll(".rate-cell").forEach(c => {
          c.classList.remove("selected-excellent", "selected-ok", "selected-poor");
          c.textContent = "";
        });

        document.querySelectorAll(".rating-chip").forEach(c => c.classList.remove("selected"));

        const stationInput = document.getElementById("station");
        const sealdah = curatedStations.find(
          (s) => s.name.toUpperCase() === "SDAH" || s.code === "621"
        );
        if (sealdah) {
          stationInput.value = sealdah.code + " - " + sealdah.name;
          stationInput.dataset.code = sealdah.code;
          stationInput.dataset.division = sealdah.divisionCode || "";
          toggleRatingSections(sealdah.divisionCode || "");
          setSubmitEnabled(true);
        }
      }
    });

    function toggleRatingSections(divisionCode) {
      const dnrSection = document.getElementById("dnrRatingSection");
      const simpleSection = document.getElementById("simpleRatingSection");

      if (!divisionCode) {
        dnrSection.style.display = "none";
        simpleSection.style.display = "none";
        return;
      }

      if (divisionCode === "DNR") {
        dnrSection.style.display = "block";
        simpleSection.style.display = "none";
      } else {
        dnrSection.style.display = "none";
        simpleSection.style.display = "block";
      }
    }

    function loadCuratedStations() {
      return fetch("https://rsmsuatapi.biputri.com/station/curated-stations/")
        .then(res => res.ok ? res.json() : Promise.reject("Failed"))
        .then(data => {
          const zones = data.station_data || [];
          curatedStations = zones.flatMap(zone =>
            (zone.divisions || []).flatMap(div =>
              (div.stations || []).map(st => ({
                code: String(st.station_code),
                name: st.station_name,
                divisionCode: st.division_code,
                divisionName: st.division_name
              }))
            )
          );

          const stationInput = document.getElementById("station");
          const sealdah = curatedStations.find(s =>
            s.name.toUpperCase() === "SDAH" || s.code === "621"
          );
          if (sealdah) {
            stationInput.value = sealdah.code + " - " + sealdah.name;
            stationInput.dataset.code = sealdah.code;
            stationInput.dataset.division = sealdah.divisionCode || "";
            toggleRatingSections(sealdah.divisionCode || "");
            setSubmitEnabled(true);
          }
        })
        .catch(err => console.error("curated-stations error", err));
    }

    function findStationInCurated(code) {
      if (!code || curatedStations.length === 0) return null;
      return curatedStations.find(s => s.code === String(code)) || null;
    }

    function detectStationFromLocation() {
      const stationInput = document.getElementById("station");
      if (!navigator.geolocation) return;

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          const url = "https://railopsapi.suvidhaen.com/microservice/station/nearest/?" +
            new URLSearchParams({ latitude: lat, longitude: lng }).toString();

          fetch(url)
            .then(res => res.json())
            .then(data => {
              let nearestCode = String(data.station_code || data.code || data.stationId || "");
              let chosen = nearestCode ? findStationInCurated(nearestCode) : null;
              if (!chosen) {
                chosen = curatedStations.find(s => s.name.toUpperCase() === "SDAH" || s.code === "621");
              }
              if (!chosen) {
                stationInput.value = "Station not found";
                stationInput.dataset.code = "";
                stationInput.dataset.division = "";
                toggleRatingSections(null);
                setSubmitEnabled(false);
                return;
              }

              stationInput.value = chosen.code + " - " + chosen.name;
              stationInput.dataset.code = chosen.code;
              stationInput.dataset.division = chosen.divisionCode || "";
              toggleRatingSections(chosen.divisionCode || "");
              setSubmitEnabled(true);
            });
        }, 
        err => console.warn("Geolocation error", err), 
        { enableHighAccuracy: true }
      );
    }

    // Rating table for DNR
    const feedbackTable = document.getElementById("feedbackTable");
    if (feedbackTable) {
      feedbackTable.addEventListener("click", e => {
        const cell = e.target.closest(".rate-cell");
        if (!cell) return;
        const row = cell.parentElement;
        const rowIndex = row.getAttribute("data-row");
        const value = cell.getAttribute("data-value");

        row.querySelectorAll(".rate-cell").forEach(c => {
          c.classList.remove("selected-excellent", "selected-ok", "selected-poor");
          c.textContent = "";
        });

        if (value === "2") cell.classList.add("selected-excellent");
        if (value === "1") cell.classList.add("selected-ok");
        if (value === "0") cell.classList.add("selected-poor");
        cell.textContent = "✓";

        rowRatings[rowIndex] = Number(value);
      });
    }

    // Overall rating for non-DNR
    const overallRatingDiv = document.getElementById("overallRating");
    if (overallRatingDiv) {
      overallRatingDiv.addEventListener("click", e => {
        const chip = e.target.closest(".rating-chip");
        if (!chip) return;
        const value = chip.getAttribute("data-value");
        overallRating = Number(value);

        overallRatingDiv.querySelectorAll(".rating-chip").forEach(c => c.classList.remove("selected"));
        chip.classList.add("selected");
      });
    }

    // Form submission
    document.getElementById("feedbackForm").addEventListener("submit", function(e) {
      e.preventDefault();

      if (!this.checkValidity()) {
        this.reportValidity();
        return;
      }

      const stationInput = document.getElementById("station");
      const stationCode = (stationInput.dataset.code || "").trim();
      const divisionCode = stationInput.dataset.division || "";

      if (!stationCode) {
        showPopup("Station not selected.");
        return;
      }

      const email = document.getElementById("email").value.trim();
      if (!email.toLowerCase().endsWith("@gmail.com")) {
        showPopup("Email must be a gmail.com address");
        return;
      }

      if (divisionCode !== "DNR" && overallRating === null) {
        showPopup("Please select overall rating");
        return;
      }

      if (divisionCode === "DNR") {
        const totalRows = document.querySelectorAll("#feedbackTable tbody tr").length;
        if (Object.keys(rowRatings).length < totalRows) {
          showPopup("Please rate all items before submitting");
          return;
        }
      }

      const payload = {
        station_code: stationCode,
        date: document.getElementById("date").value,
        passenger_name: document.getElementById("name").value,
        ticket_no: document.getElementById("ticket").value,
        mobile: document.getElementById("mobile").value,
        email: email,
        overall_rating: overallRating,
        item_ratings: rowRatings
      };

      fetch("https://rsmsuatapi.biputri.com/api/feedback/public/feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => {
        if (!res.ok) throw new Error("Submit failed: " + res.status);
        return res.json().catch(() => ({}));
      })
      .then(data => showPopup("Thank you for submitting your feedback!", true))
      .catch(err => showPopup("Failed to submit feedback. Please try again."));
    });

    window.addEventListener("load", () => {
      setTodayDate();
      document.getElementById("dnrRatingSection").style.display = "none";
      document.getElementById("simpleRatingSection").style.display = "none";
      setSubmitEnabled(false);
      loadCuratedStations().then(detectStationFromLocation);
    });
  </script>
</body>
</html>
